## Testing Framework Implementation

### Context

- Implementing testing framework with Vitest + Testing Library for unit/integration tests
- Using Playwright for E2E testing
- Focus on crucial and complicated parts of the codebase
- Coverage requirements set: 80% general, 90% for critical paths
- Following Next.js conventions with **tests** directory naming
- All testing standards documented in [Testing Framework Documentation](/docs/features/testing-framework/)

### Selected Stack

1. Unit & Integration Testing:

- Vitest
- React Testing Library
- MSW for API mocking
- Testing Library User Event for interactions
- See [Unit Testing Guidelines](/docs/features/testing-framework/unit-testing.md) for best practices

2. E2E Testing:

- Playwright
- Built-in test recorder
- Cross-browser testing
- Mobile viewport testing
- See [E2E Testing Guidelines](/docs/features/testing-framework/e2e-testing.md) for implementation details

### Implementation Plan

Step 1: Vitest + Testing Library Setup
[X] Install dependencies (vitest, @testing-library/react, @testing-library/user-event, msw)
[X] Configure Vitest for TypeScript and React
[X] Set up test environment with happy-dom
[X] Create test utilities and common mocks
[X] Add basic smoke test to verify setup
[X] Standardize test directory structure using **tests** prefix
[X] Document setup in [Test Environment Setup](/docs/features/testing-framework/environment-setup.md)

Step 2: Critical Path Testing Setup
[X] Set up test structure for core features
[-] Create test database configuration (Decided to use MSW instead)
[X] Implement MSW handlers for API mocking
[X] Add common test utilities and fixtures
[X] Set up coverage reporting with thresholds (80% general, 90% critical paths)
[X] Document in [Testing Coverage Standards](/docs/features/testing-framework/coverage-standards.md)

Step 3: Initial Test Implementation
[X] Test IframeContainer state management
[X] Test URL menu state transitions
[X] Test authentication flows
[X] Test API route handlers
[X] Reference patterns from [Component Test Patterns](/docs/features/testing-framework/component-patterns.md)

Step 4: Playwright Setup
[X] Install and configure Playwright
[X] Set up E2E test environment
[X] Add authentication test helpers
[X] Create test database seeding utilities
[‚úì] E2E testing moved to dedicated plan (see: docs/working-memory/open/e2e-test-expansion-20250331/.plan)
[X] Follow guidelines in [Playwright E2E Standards](/docs/features/testing-framework/playwright-standards.md)

Step 5: Comprehensive API Route Testing
[X] Map all API endpoints and their expected responses
[X] Create test suite structure for API routes:
    - Admin Routes:
      * App Configuration (/api/admin/app-config/*)
        - GET, PATCH /api/admin/app-config
        - GET, POST, DELETE /api/admin/app-config/logo
        - PATCH /api/admin/app-config/theme
        - PATCH /api/admin/app-config/registration
        - GET, POST, DELETE /api/admin/app-config/favicon
      * User Management (/api/admin/users/*)
      * URL Management (/api/admin/urls/*)
      * URL Groups (/api/admin/url-groups/*)
      * Statistics (/api/admin/stats)
      * Icons (/api/admin/icons)
    - User Routes:
      * Authentication (/api/auth/*)
      * User Preferences (/api/user/preferences)
      * User Avatar (/api/user/avatar)
    - System Routes:
      * Health Check (/api/health)
      * First Run (/api/first-run/*)
[X] Document API endpoints in [API Testing Map](/docs/features/testing-framework/api-endpoints.md)

[X] Implement standardized test patterns for each endpoint:
    - Success cases with expected data
    - Authentication/Authorization:
      * Unauthenticated access
      * Non-admin access to admin routes
      * Invalid tokens
    - Input Validation:
      * Missing required fields
      * Invalid data types
      * Boundary conditions
    - Error Handling:
      * Database errors
      * File system errors
      * Network errors
    - File Operations (where applicable):
      * Upload limits
      * File type validation
      * Storage/cleanup
[X] Follow [API Test Patterns](/docs/features/testing-framework/api-test-patterns.md) for implementation

[X] Implement missing tests for identified endpoints:
    1. App Config Endpoints:
       - [X] /api/admin/app-config/favicon (GET, POST, DELETE) - Completed in API test review
       - [X] /api/admin/app-config/theme (PATCH) - Completed in API test review
    2. Backup/Restore Endpoints:
       - [X] /api/admin/backup (GET, POST) - Completed
       - [X] /api/first-run/restore (POST) - Completed
    3. User Endpoints:
       - [X] /api/user/avatar (GET) - Completed in API test review
    4. URL Group Management:
       - [X] /api/admin/url-groups/[id]/urls/batch (GET, POST) - Completed in API test review
       - [X] /api/admin/url-groups/[id]/urls (GET, POST) - Completed
       - [X] /api/admin/url-groups/[id]/urls/[urlId] (GET, PATCH, DELETE) - Completed
[X] Reference examples from [API Test Examples](/docs/features/testing-framework/api-test-examples.md)

[~] Add response schema validation using TypeScript types
    - [X] Create type-validation.ts utility with validators for common types
    - [X] Document validation approach in type-validation.md
    - [X] Implement validation for backup API (GET, POST)
    - [X] Implement validation for restore API (POST)
    - [ ] Create shared validators for common response patterns
    - [ ] Implement validators for URL group endpoints
    - Follow [Type Validation Standards](/docs/features/testing-framework/type-validation.md)
[~] Create performance benchmarks:
    - [X] Response time tracking - Added with measureTestTime in API test review
    - [X] Memory usage monitoring - Added in API test review
    - [~] File operation metrics
    - Reference [Performance Testing Guidelines](/docs/features/testing-framework/performance-testing.md)
[X] Create future plan to expand e2e coverage

### Current Status (Updated 2025-05-15 16:42)

1. Fix Remaining Test Issues
   [‚úì] Review and update all cookie-related tests to use async methods
   [‚úì] Audit statistics endpoint tests for proper type handling
   [‚úì] Verify proper error handling in admin routes
   [‚úì] Ensure consistent mocking patterns across all tests
   [‚úì] Create centralized mocking utilities
   [‚úì] All fixes documented in [Test Fixes Guide](/docs/features/testing-framework/test-fixes.md)

2. Enhance Test Coverage
   [‚úì] Add comprehensive tests for error states in statistics endpoints
   [‚úì] Implement boundary testing for admin dashboard data
   [‚úì] Add tests for cookie persistence scenarios
   [‚úì] Verify proper cleanup in all file operation tests
   [‚úì] Follow coverage standards in [Testing Coverage Standards](/docs/features/testing-framework/coverage-standards.md)

3. Test Infrastructure Improvements
   [‚úì] Implement standardized cookie mocking utilities
   [‚úì] Create helpers for common statistics test scenarios
   [‚úì] Add type validation utilities for response structures
   [ ] Set up automated test stability monitoring
   [‚úì] Based on [Test Utilities Guide](/docs/features/testing-framework/test-utilities.md)

4. Documentation Updates
   [‚úì] Document cookie handling patterns in tests
   [‚úì] Add section on proper mocking strategies
   [‚úì] Update statistics endpoint testing guidelines
      - Created comprehensive guidelines for both detailed and basic statistics endpoints
      - Documented test categories: auth, validation, edge cases
      - Added examples of mock data generation and common test scenarios
      - Included best practices and common pitfalls to avoid
      - Added performance testing guidelines
   [‚úì] Document error handling patterns - Completed in API test review
      - See [Error Handling Patterns](/docs/features/testing-framework/error-handling-patterns.md)
   [‚úì] Document test data management practices - Completed in API test review
      - See [Test Data Management](/docs/features/testing-framework/test-data-management.md)
   [‚úì] Document API test coverage metrics - Completed in API test review
      - See [API Test Coverage](/docs/features/testing-framework/api-test-coverage.md)
   [‚úì] Add performance monitoring guidelines - Completed in API test review
      - See [Performance Testing Guidelines](/docs/features/testing-framework/performance-testing.md)

5. Quality Assurance
   [‚úì] Run full test suite audit for flaky tests
      - Identified timing-dependent tests in IframeContainer and auth components
      - Found resource cleanup issues in file operations and database tests
      - Discovered race conditions in concurrent operations
      - Documented network-dependent test issues
      - Created comprehensive recommendations for fixes
      - Established monitoring and prevention strategies
      - Documented in [Test Stability Guide](/docs/features/testing-framework/test-stability.md)
   [~] Verify coverage metrics meet thresholds
   [‚úì] Review error handling comprehensiveness
   [‚úì] Check for proper cleanup in all tests
   [ ] Implement automated test stability monitoring
   [~] Add performance benchmarks for critical paths - Partially completed in API test review

### Progress History

### 2025-05-15 16:42 - Response Schema Validation Implementation
- ‚úì Completed: Implementation of type validation for API responses
- ‚úì Achievements:
  * Implemented type-validation.ts utility with comprehensive validator functions
  * Added proper type validators for backup and restore endpoints
  * Created detailed documentation in type-validation.md
  * Successfully validated both success and error response structures
  * Integrated validation with performance monitoring
  * Fixed formatting issues in response validation
  * Used consistent validation patterns across tests
  * All tests passing with proper validation
- ü§î Decisions:
  * Used TypeScript generics for type safety
  * Created reusable validator patterns for common response structures
  * Implemented both validation and assertion functions
  * Provided detailed error messages for debugging
  * Used composition pattern for nested object validation
- ‚è≠Ô∏è Next:
  * Create shared validators for common response patterns
  * Implement validators for URL group endpoints
  * Set up automated test stability monitoring
  * Verify coverage metrics meet thresholds
  * Continue with file operation metrics implementation

### 2025-05-15 14:03 - URL Group URL ID Testing Completion
- ‚úì Completed: Implementation of /api/admin/url-groups/[id]/urls/[urlId] API tests
- ‚úì Achievements:
  * Fixed all test failures in the URL ID endpoint tests
  * Implemented proper authentication and authorization tests
  * Fixed database mocking issues in PATCH, DELETE, and PUT handlers
  * Properly handled error cases with appropriate status codes
  * Added appropriate validation tests for displayOrder and required fields
  * Used consistent pattern for database transaction mocking
  * Applied performance monitoring with measureTestTime
  * Used proper error handling with try/catch/finally blocks
  * Ensured all 18 tests pass consistently
  * Properly mocked the URL reordering functionality
- ü§î Decisions:
  * Used resetAllMocks() strategically at the beginning of each test
  * Adjusted mock implementation to match actual route behavior
  * Properly structured remaining URLs array for reordering tests
  * Used proper error pattern for database error simulation
- ‚è≠Ô∏è Next:
  * Set up automated test stability monitoring
  * Verify coverage metrics meet thresholds
  * Add test runtime performance tracking for remaining endpoints

### 2025-05-14 17:30 - URL Group URLs Testing Completion
- ‚úì Completed: Implementation of /api/admin/url-groups/[id]/urls API tests
- ‚úì Achievements:
  * Implemented comprehensive test suite for all HTTP methods (GET, POST, PUT, DELETE)
  * Added proper test cases for authentication, authorization, validation, and error handling
  * Fixed implementation of database error testing with proper transaction mocking
  * Applied performance monitoring with measureTestTime
  * Used proper error handling with try/catch/finally blocks and debugError
  * Fixed mock implementation issues to ensure tests pass consistently
  * Fixed URL group not found tests
  * Properly handling authorization test cases
  * Implemented proper response assertions
- ü§î Decisions:
  * Used consistent mock patterns for database operations
  * Aligned test assertions with actual route implementation behavior
  * Applied standardized test lifecycle hooks
  * Adjusted test expectations to match actual route behavior
  * Used vi.clearAllMocks() strategically to ensure accurate call count assertions
- ‚è≠Ô∏è Next:
  * Begin /api/admin/url-groups/[id]/urls/[urlId] endpoint tests
  * Continue following test patterns established in URL Group URLs tests

### 2025-05-12 18:45 - Backup API Test Improvements
- ‚úì Completed: Refactoring of backup API tests to use existing utilities
- ‚úì Achievements:
  * Identified and used existing createTestFileBlob utility from file.factory.ts
  * Removed redundant file-mock.ts implementation
  * Improved code reuse and maintainability
  * Verified all tests pass with updated implementation
  * Applied proper performance monitoring
  * Maintained test coverage and functionality
- ü§î Decisions:
  * Used existing file factory instead of creating new utility
  * Followed DRY principles by removing duplicate code
  * Maintained consistent test patterns across codebase
- ‚è≠Ô∏è Next:
  * Begin URL Group Management endpoint tests
  * Focus on /api/admin/url-groups/[id]/urls endpoints

### 2025-05-12 18:20 - First Run Restore Testing Completion
- ‚úì Completed: Implementation of /api/first-run/restore API tests
- ‚úì Achievements:
  * Implemented comprehensive test suite for restore endpoint
  * Added proper mock implementation for fs/promises and path modules
  * Implemented tests for all key scenarios: successful restore, authorization, validation, errors
  * Applied performance monitoring with measureTestTime
  * Used proper error handling and debugging
  * Fixed mock implementation issues
- ü§î Decisions:
  * Used consistent mock patterns for file system operations
  * Aligned test status code expectations with actual implementation
  * Applied standardized test lifecycle hooks
- ‚è≠Ô∏è Next:
  * Complete backup API test implementation
  * Implement URL Group Management endpoint tests
  * Update plan to reflect progress

### 2025-05-12 18:14 - Backup API Testing Progress
- ‚úì Completed: Initial implementation of /api/admin/backup API tests
- ‚úì Achievements:
  * Implemented proper mocking of fs/promises module for file operations
  * Added performance monitoring with measureTestTime utility
  * Implemented proper error handling and debugging support
  * Added test cases for both GET and POST methods
  * Fixed issues with response body consumption
  * Set up test lifecycle with proper before/after hooks
  * Referenced [File Operation Testing Guide](/docs/features/testing-framework/file-operation-testing.md)
- ü§î Decisions:
  * Used proper mocking for file system operations instead of direct file access
  * Applied structured error handling pattern with try/catch/finally blocks
  * Followed performance monitoring standards with THRESHOLDS constants
  * Applied test data management best practices
  * Based on patterns from [API Test Patterns](/docs/features/testing-framework/api-test-patterns.md)
- ‚ùå Issues:
  * Remaining test errors related to mock implementation and response handling
  * Need to fix undefined property access in tests
  * Will troubleshoot using [Troubleshooting Guide](/docs/features/testing-framework/troubleshooting-guide.md)
- ‚è≠Ô∏è Next:
  * Fix remaining backup API test issues
  * Complete POST method test implementation
  * Begin /api/first-run/restore endpoint tests
  * Reference [API Test Examples](/docs/features/testing-framework/api-test-examples.md) for implementation

### 2025-05-08 22:07 - API Test Review Integration
- ‚úì Completed: Comprehensive API test review project integrated with testing framework
- ‚úì Achievements:
  * Added consistent error handling with try/catch/finally blocks and debugError utility
  * Implemented standardized performance monitoring with measureTestTime and THRESHOLDS
  * Enhanced type safety with proper response type assertions
  * Improved test data management with factory functions
  * Verified all tests pass with proper mock implementation
  * Updated all documentation in testing framework
  * Achieved 100% route and HTTP method coverage
  * Completed many previously open test implementations:
    - /api/admin/app-config/favicon (GET, POST, DELETE)
    - /api/admin/app-config/theme (PATCH)
    - /api/user/avatar (GET)
    - /api/admin/url-groups/[id]/urls/batch
  * All implementations follow [API Test Standards](/docs/features/testing-framework/api-test-standards.md)
- ü§î Decisions:
  * Integrated all improvements from API test review
  * Updated documentation with real-world examples
  * Standardized patterns across all API tests
  * Used measureTestTime and THRESHOLDS consistently
  * Applied patterns from [Performance Testing Guidelines](/docs/features/testing-framework/performance-testing.md)
- ‚è≠Ô∏è Next: Focus on implementing remaining Backup/Restore endpoints

2024-04-03:
- [X] Completed cookie handling patterns and documentation
- [X] Implemented comprehensive flaky test audit
- [X] Completed statistics endpoint testing implementation and guidelines
- [X] Added test data generation utilities
- [X] Implemented response validation helpers
- [X] Created comprehensive API test coverage metrics documentation
- [X] All patterns documented in [Testing Framework Documentation](/docs/features/testing-framework/)

## Remaining Tasks

1. API Route Testing
- [‚úì] Implement standardized test patterns for remaining API routes
    * Priority 1: Backup/Restore endpoints
      - [‚úì] /api/admin/backup (GET, POST) - Completed and optimized
      - [‚úì] /api/first-run/restore (POST) - Completed
    * Priority 2: URL Group Management endpoints
      - [‚úì] /api/admin/url-groups/[id]/urls (GET, POST, PUT, DELETE) - Completed
      - [‚úì] /api/admin/url-groups/[id]/urls/[urlId] (GET, PATCH, DELETE) - Completed
    * Follow patterns in [API Test Patterns](/docs/features/testing-framework/api-test-patterns.md)
- [~] Add response schema validation for all endpoints
    * [‚úì] Implemented type-validation utility
    * [‚úì] Documented validation approach
    * [‚úì] Applied validation to backup and restore endpoints
    * [ ] Create shared validators for common response patterns
    * [ ] Apply validation to URL group endpoints
    * Reference [Type Validation Standards](/docs/features/testing-framework/type-validation.md)
- [X] Document API test coverage metrics
      See: [API Test Coverage](/docs/features/testing-framework/api-test-coverage.md)
- [~] Add performance benchmarks for critical API endpoints - Started with measureTestTime in API test review
      * Follow guidelines in [Performance Testing Guidelines](/docs/features/testing-framework/performance-testing.md)

2. Test Infrastructure
- [ ] Set up automated test stability monitoring
    * Use guidance from [Test Stability Guide](/docs/features/testing-framework/test-stability.md)
- [ ] Implement test result aggregation and reporting
    * Follow standards in [Test Reporting Guide](/docs/features/testing-framework/test-reporting.md)
- [ ] Add test runtime performance tracking
    * Reference [Performance Testing Guidelines](/docs/features/testing-framework/performance-testing.md)

3. Documentation
- [X] Complete error handling patterns documentation
      See: [Error Handling Patterns](/docs/features/testing-framework/error-handling-patterns.md)
- [X] Add troubleshooting guide for common test failures
      See: [Troubleshooting Guide](/docs/features/testing-framework/troubleshooting-guide.md)
- [X] Document test data management best practices
      See: [Test Data Management](/docs/features/testing-framework/test-data-management.md)

4. Quality Assurance
- [ ] Verify test coverage meets thresholds
    * Use criteria from [Testing Coverage Standards](/docs/features/testing-framework/coverage-standards.md)
- [ ] Implement automated flaky test detection
    * Follow approach in [Test Stability Guide](/docs/features/testing-framework/test-stability.md)
- [ ] Add performance benchmarks for critical paths
    * Based on [Performance Testing Guidelines](/docs/features/testing-framework/performance-testing.md)

## Next Steps
1. Create shared validators for common response patterns
   * Extract common validator patterns (error responses, pagination, etc.)
   * Add to test/helpers/validators/ directory
   * Document in type-validation.md

2. Apply response schema validation to URL group endpoints
   * Add validators to /api/admin/url-groups/[id]/urls tests
   * Add validators to /api/admin/url-groups/[id]/urls/[urlId] tests
   * Validate success, error, and edge case responses

3. Set up automated test stability monitoring
   * Research options for test stability metrics collection
   * Create reporting mechanism for flaky tests
   * Integrate with CI pipeline
   * Document in [Test Stability Guide](/docs/features/testing-framework/test-stability.md)

4. Verify coverage metrics meet thresholds
   * Run coverage report for entire test suite
   * Identify areas below thresholds
   * Create plan to address low-coverage areas
   * Document in [Testing Coverage Standards](/docs/features/testing-framework/coverage-standards.md)

5. Fix remaining test failures in:
   * app/api/admin/url-groups/route.test.ts:
     - GET test where data.urls is undefined instead of array
     - PUT test with 500 status instead of 200
   * app/api/admin/users/[id]/avatar/route.test.ts:
     - Performance test timing threshold exceeded (480ms vs 200ms limit)
